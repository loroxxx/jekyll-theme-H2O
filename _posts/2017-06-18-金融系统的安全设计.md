---
layout: post
title: '金融系统的安全设计'
subtitle: '金融系统的安全设计'
date: 2017-06-18
categories: 技术
cover: ''
tags: 金融系统 安全 设计 漏洞
---


# 金融系统的安全设计


##### 原则：
1. 不要相信前端传过来的数据是安全的，假设前端的数据是恶意篡改过的，后端系统如何确保系统安全
2. 过滤xss注入和sql注入
3. 对上层数据做必要的校验
3. 涉及到用户的重要信息，从session获得
4. 控制权限

---

总结一些在web开发中常见的安全漏洞和解决方法
在银行开发的时候，每次项目在上线的时候都会进行一次安全检查，会扫描出不少的安全漏洞。
在此做些整理，方便以后用得上.


1.脚本攻击
- 	xxs
- 	sql

2.暴力破解
- 	 账户枚举
	 

3.短信攻击

4.越权访问
- 	CSRF 
- 	水平权限
- 	垂直权限

5.信息泄漏

6.重复攻击

6.其他问题
单用户登录

---
### 1.XSS (跨站脚本攻击)

######  描述：
XSS是常见安全类漏洞，主要原因是开发人员在服务端没有对传入的参数进行校验和过滤，
导致攻击者可以提交非法字符串到服务端并诱导他人执行恶意脚本。

###### 例子：
最常见的一种攻击就是：攻击方把一串javascript代码传输到了服务端，然后服务端没有过滤又显示在了被攻击方的电脑上
，然后执行了javascript代码。


###### 解决方法：

1. 对于有规则的参数（如数字、身份证号、年龄、电话号码、交易流水号……等）
应尽量采用白名单正则表达式的方式，在服务端对客户端传来的参数进行校验，检查客户端传到服务端的参数是否符合既定的规则，如不符合则拒收； 

2. 对于无规则但有长度限制（一般20字节内，越短越好）的参数，应在服务端校验客户端
传入的参数长度，如果长度超标则拒收； 

3. 对于无规则且无长度限制或超过20字节长度的参数（如论坛BBS帖子），建议在服务端过
滤掉客户端传入参数中的所有特殊字符（除大小写字母、数字、下划线以外的其他所有字符），如果因为特殊原因不能过滤某些特殊字符，应考虑将半角特殊字符转换成全角字符或进行HTMLEncode转码(例如把“<”、“>”转换为“<”、“>”)后再处理，这样显示出来差别不会太大； 

4. 如果客户端传入的参数需要入库保存，则在入库前或出库后需要对全部参数进行HTMLEncode
编码然后再保存，出库时确保参数也是HTMLEncode形式回显在客户端浏览器上。 

5. 任何情况下，严禁从客户端接收参数后直接回显在浏览器上，以防恶意脚本执行。




### 2.CSRF (跨站伪造攻击)

描述：后台管理模块中重要操作（如添加帐号、提权、删除、充值、转账…等）的action由于是直接以固定URL、固定参数传入，
没有增加随机的csrf token验证，导致攻击者可以构造恶意的链接（如把黑客提升为管理员的url链接）并诱骗管理员点击，
管理员一旦点击即可把黑客提升为管理员或执行其他恶意操作。
 
 例子：攻击者截获一串url，就能用这串url对服务器进行特定操作
 
 解决方法：每次重要的请求都要有时效性，唯一性。
 
 在后台重要操作action的request中增加随机的csrf token（token应在服务端随机生成），
 每次执行重要操作前先验证token是否是在对应的session中生成，如果不是，则拒绝执行action。
 由于黑客不知道其他用户对应session的随机token，因此无法构造出合适的链接诱骗他人执行恶意操作。
 采用csrf token是规避CSRF攻击的一种常见手段。
 
 
### 3.越权访问(水平权限)

这种漏洞的基本原理有两种： 
第1种：把标识用户身份的信息（包括但不限于username、EMP_ID、session_id、个人token……等）
以http request GET/POST方式传递给调用接口执行，例如执行一个查询工资的请求： 
http://www.abc.com/query.do?emp_id=E06S02084536&item=salary 
攻击者只要拦截http请求将emp_id改为其他人的工号即可越权查询他人工资信息。 

第2种：不需要传递身份信息，但传入的参数有一定规则（如ID、身份证号、手机号等），
攻击者可以通过遍历参数越权查看其他信息。例如执行一个查询银行卡信息的请求：
 http://www.abc.com/query.do?card=006900000828281 
攻击者只要修改card参数遍历其他卡号8281、8282、8283、8284…即可遍历越权查询其他卡号的信息。 
 
### 4.越权访问(垂直越权)

原理同上，由于传入的身份标识存在不同级别、不同权限，因此可以通过篡改传入的身份标识看到本来应该高权限帐户才能看到的内容。 
例如以下链接导出报表的action本来只能导出peter名下的报表： 
http://www.ab.com/export?uid=peter&data=2016-08-08 
如果拦截request请求把peter篡改为admin将有可能导出完整的全量报表。 

解决方法：
1、 标识用户身份的信息必不能通过http GET/POST传递、接收，必须将身份标识信息放在session中，每次需要验证身份时从session中取出使用，绝不接收GET/POST传来的身份标识； 
2、 所有需要登录才可以调用执行的增删改查action操作，必须验证并限定用户只能增删改查自己名下的数据。相当于在该用户的增删改查SQL中默认要增加where uid=GetCurrentUser(session)的限定条件； 
3、 对于不需要登录就可以在系统外部公开调用的增删改查接口： 
a) 应避免将重要敏感信息（如身份信息、卡号信息、资金信息等）通过公开接口查询； 
b) 尽量避免用有规律、可遍历的字符串、数字等作为传入调用接口的参数，防止被爬网； 
c) 为公开调用的查询接口增加图形验证码，防止被刷单；
 
 
 
###  5.多重登录
 
 描述：同一个帐号可以同时在多个地方登录，可能会发生帐号盗用事件。
 
 解决方案：服务端做判断，每次新session登录把上一个session踢出并提示新session的登录地点。
 原理：服务端维护一个用户的状态，当有新用户进来时，就把旧用户的session状态设为已注销
 
 
###  6.账户枚举
 
描述:这种问题主要出现在登录模块，如果输入正确的帐号、错误的密码，系统会提示“密码错误”；如果输入不存在的帐号，系统会提示“帐号不存在” —— 黑客根据系统返显的提示信息即可判断出来这个帐号是否存在。如果帐号再有一定规律（例如可以遍历的字符串，如手机号、身份证号等），则黑客可以跑批撞出大量系统中已存在的帐号，进而可以再次撞破暴力破解密码。
 
 解决方案：不要提示二义性信息，应进行中性提示，即无论帐号是否存在、密码是否错误，只要帐号密码不匹配都提示“帐号或密码输入错误，请重新输入”
 
### 7.暴力破解
 描述：在登录验证、找回密码模块未加验证码，且未设置5次尝试失败锁定帐户功能，因而攻击者可以暴力破解帐号密码。
 
 解决方案：
1、 在登录验证、找回密码模块增加图形验证码； 
2、 系统限定5次登录失败应锁定一定时间，防止黑客暴力破解； 
3.在用户设置密码时。提示或者强制要求用户设置一定复杂度的密码（大小写字母、数字、特殊字符组合，长度不小于8位）


### 9.SQL注入

描述:同XSS一样，SQL注射也是常见安全漏洞，主要原因是开发人员没有在服务端对客户端传来的参数进行校验和过滤，因而可以构造畸形字符串注入数据库执行。

解决方案：
1、 对于int 、long、double等数字类型参数，服务端在接收客户端传来的参数后应强制转换成对应的类型然后再使用，如果出现转换异常则抛出异常不再继续执行； 

2、 对于字符串类型参数，服务端在接收客户端传来的参数后，应按上述XSS同样的规则对参数进行处理、校验和过滤。（特别是对于单引号、双引号、圆括号、尖括号、加减乘除符号等） 

3、 将客户端传来的参数转为小写字母后，过滤掉SQL关键字（包括但不限于“select”、“update”、“delete”、“insert、”“from”、“where”、“group”、“order”……等） 


### 10.JSON泄漏

描述：
这是银行各系统常见的一种安全漏洞。 
银行多套系统架构采用的是MVC架构，但采用的是JSON对象在View与Controller之间传送，
这虽然带来一定的开发便利并提高了传输效率，却也带来了一些信息泄漏的安全问题。 
由于客户端与服务端之间传送的是JSON对象，多数情况下（例如查询）服务端返回给客户端的也是一个JSON对象，
这个JSON包含了对象的全部属性（如客户ID、姓名、生日、身份证号、手机号、家庭住址、银行卡号/甚至银行卡密码……），
但多数情况下大部分信息是需要屏蔽脱敏的，甚至禁止返回给浏览器的（例如首页上挂出的中奖客户清单，
虽然在HTML中把姓名用“*”屏蔽了，但是黑客在页面的HTML代码中仍然可以找到全部中奖客户的JSON对象、全部属性字段，
进而导致信息泄密），此外，通过网络嗅探抓包的方式也可能获取这些JSON对象的敏感字段。

解决方案：
服务器返回所有的JSON对象到客户端浏览器之前，应先对JSON进行脱敏处理，需要返回哪个属性就提取哪个属性，其他属性全部屏蔽处理。


### 短信攻击：

1.手机号篡改(高风险)

描述:某些页面在调用客户预留的手机号发送OTP时，并不是在服务端从后台数据库中取出客户预留的手机号并发送OTP，
而是将要发送OTP的目标客户手机号（即客户预留的手机号）以明文或Hidden 的方式显示在客户端HTML中，
进而导致黑客可以拦截篡改要发送的目手机号，
把OTP发送到黑客的手机号上去，进而绕过系统验证

解决方案：
1、重要资金、帐户类操作，应让客户通过在柜面预留手机号的方式把客户手机号录入数据库，并在系统中调用数据库中存放的手机号发送短信，而不应该让客户自行填写手机号发送短信，
更不应该把客户预留的手机号明文存放在客户端Hidden中并提交。 
2、验证客户提交的OTP时，应首先验证这个OTP对应的手机号是不是客户预留的手机号
，而不是先验证OTP短信跟客户发出的请求是不是匹配的。


3.短信定制
描述：某些系统在调用短信网关发送短信时不是调用预留的固定短信模版发送短信，
而是可以自定义参数传入短信网关发送短信，从而导致黑客可以自定义钓鱼短信并调用银行官方短信接口进行短信群发，
由于钓鱼短信是从官方渠道发出的，因而诱惑性、危害性非常大。

解决方案：前端不应直接传入短信内容的相关参数调用短信网关，只能调用特定的短信模版，
由后端服务器按照短信模版的固定内容调用短信网关发送短信，
确保短信内容不会被非法篡改。

4.短信炸弹

短信发送、OTP发送模块因为没有在服务端限制发送短信的目标手机号、时间频率等信息，导致黑客可以任意填写手机号向目标手机号频繁发送垃圾短信，造成手机炸弹。

1、 所有会调用短信接口的地方，加上图形验证码限制； 

2、 在服务端限制向同一手机号发送短信的频率（如每天或每小时只能发送5条） 


明文传输
主要是采用了不安全的明文HTTP传输协议，或者敏感信息（如帐号密码、资金字段等）在传输过程中未加密，黑客可能通过嗅探抓包获取这些信息。

对于重要功能采用https加密，对于重要的业务字段，也应通过对称或非对称加密算法加密，确保业务数据在传输过程中不会被拦截篡改。



重放攻击
关键功能（如论坛BBS、橙E网提单等）上没有设置图形验证码等防刷机制，攻击者可以连续重放request请求频繁提单、刷单、广告灌水造成后台大量垃圾信息。

1、 关键功能处设置图形验证码； 

2、 服务端限定单个客户发言、提单的时间频率（如每分钟只能提1单）； 

信息遍历
增加图形验证码防刷功能。


### 控制失效(高风险)

这种漏洞纯粹是编码问题，编码失败导致应实现的功能未实现。例如验证码未生效 或使用后未主动从内存中删除、输入任意帐号都可以通过系统认证等。

加强开发能力和测试案例。


**
